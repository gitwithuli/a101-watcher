name: A101 Email Watcher (5 min)

on:
  schedule:
    - cron: "*/5 * * * *"   # every 5 minutes (UTC)
  workflow_dispatch: {}

jobs:
  check:
    runs-on: ubuntu-latest
    steps:
      - name: Check out repo
        uses: actions/checkout@v4

      - name: Show repo contents (sanity check)
        run: |
          pwd
          ls -la
          echo "---- python file? ----"
          [ -f watch_a101_email.py ] && echo "✅ found watch_a101_email.py" || (echo "❌ watch_a101_email.py missing" && exit 1)

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install Python deps
        run: |
          python -m pip install --upgrade pip
          pip install playwright

      - name: Verify Playwright install
        run: |
          python - << 'PY'
          import sys
          import playwright
          print("python:", sys.version)
          print("playwright:", playwright.__version__)
          PY

      # Try installing Chromium + OS deps. If the '--with-deps' path isn't supported, fall back.
      - name: Install Playwright browsers (with deps, then fallback)
        run: |
          set -euxo pipefail
          if python -m playwright install --with-deps chromium; then
            echo "Installed with --with-deps"
          else
            echo "Falling back to apt-get + plain install"
            sudo apt-get update
            sudo apt-get install -y libnss3 libx11-xcb1 libxcomposite1 libxcursor1 \
              libxdamage1 libxi6 libxtst6 libglib2.0-0 libgtk-3-0 libdrm2 libgbm1 \
              libasound2 libpangocairo-1.0-0 libxrandr2 libxfixes3 libpango-1.0-0 \
              libcups2 libxkbcommon0 libxshmfence1 libnspr4 libatk1.0-0 \
              libatk-bridge2.0-0 libatspi2.0-0 fonts-liberation
            python -m playwright install chromium
          fi

      - name: Run watcher
        env:
          A101_URL: https://www.a101.com.tr/liste/a101-ekstra-apple
          SEARCH_TEXT: Apple iPhone 17 256 GB Cep
          SMTP_HOST: ${{ secrets.SMTPHOST }}
          SMTP_PORT: ${{ secrets.SMTPPORT }}
          SMTP_USER: ${{ secrets.SMTPUSER }}
          SMTP_PASS: ${{ secrets.SMTPPASS }}
          FROM_EMAIL: ${{ secrets.FROMEMAIL }}
          TO_EMAIL: ${{ secrets.TOEMAIL }}
          HEADLESS: "1"
        run: python watch_a101_email.py
